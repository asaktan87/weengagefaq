<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Intranet FAQ Bot</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root { --ring: 59 130 246; }
    .chat-message { animation: slideIn .25s ease-out; }
    @keyframes slideIn { from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:translateY(0)} }
    .typing-indicator { animation: pulse 1.4s infinite; }
    @keyframes pulse { 0%,100%{opacity:.5} 50%{opacity:1} }
    mark { padding: 0 .15rem; border-radius: .25rem; }
  </style>
</head>
<body class="min-h-full bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-slate-900 dark:to-slate-950">
  <div class="container mx-auto px-4 py-8 max-w-4xl">
    <!-- Header -->
    <header class="text-center mb-8">
      <div id="brandBadge" class="inline-flex items-center justify-center w-16 h-16 rounded-full mb-4 bg-blue-600">
        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
      </div>
      <h1 id="brandTitle" class="text-3xl font-bold text-gray-900 dark:text-gray-100 mb-2">FAQ Assistant</h1>
      <p id="brandSubtitle" class="text-gray-600 dark:text-gray-300">Get instant answers to your workplace questions</p>

      <div class="mt-4 flex items-center justify-center gap-2">
        <button id="darkToggle" class="px-3 py-1.5 text-sm rounded-lg border border-gray-300 dark:border-gray-700 text-gray-700 dark:text-gray-200 bg-white dark:bg-slate-800 hover:bg-gray-50 dark:hover:bg-slate-700">
          Toggle dark mode
        </button>
      </div>
    </header>

    <!-- Quick Categories -->
    <section class="mb-6">
      <h2 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-3">Popular Topics</h2>
      <div id="categoryButtons" class="flex flex-wrap gap-2">
        <button onclick="selectCategory('employees')" class="px-4 py-2 bg-white dark:bg-slate-900 rounded-full text-sm font-medium text-gray-700 dark:text-gray-100 hover:bg-blue-50 dark:hover:bg-slate-800 hover:text-blue-600 transition-colors border border-gray-200 dark:border-gray-700">
          üë©‚Äçüíº Employees
        </button>
        <button onclick="selectCategory('managers')" class="px-4 py-2 bg-white dark:bg-slate-900 rounded-full text-sm font-medium text-gray-700 dark:text-gray-100 hover:bg-blue-50 dark:hover:bg-slate-800 hover:text-blue-600 transition-colors border border-gray-200 dark:border-gray-700">
          üë®‚Äçüíº Managers
        </button>
        <button onclick="selectCategory('hrbps')" class="px-4 py-2 bg-white dark:bg-slate-900 rounded-full text-sm font-medium text-gray-700 dark:text-gray-100 hover:bg-blue-50 dark:hover:bg-slate-800 hover:text-blue-600 transition-colors border border-gray-200 dark:border-gray-700">
          üß© HRBPs
        </button>
        <button onclick="selectCategory('production')" class="px-4 py-2 bg-white dark:bg-slate-900 rounded-full text-sm font-medium text-gray-700 dark:text-gray-100 hover:bg-blue-50 dark:hover:bg-slate-800 hover:text-blue-600 transition-colors border border-gray-200 dark:border-gray-700">
          üè≠ Production Site
        </button>
      </div>
    </section>

    <!-- Chat Interface -->
    <section aria-label="FAQ chat" class="bg-white dark:bg-slate-900 rounded-lg shadow-lg overflow-hidden">
      <!-- Chat Messages -->
      <div id="chatMessages" class="h-96 overflow-y-auto p-6 space-y-4" aria-live="polite">
        <div class="chat-message flex items-start space-x-3">
          <div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 text-white" id="botAvatar" style="background:#2563eb">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
            </svg>
          </div>
          <div class="bg-gray-100 dark:bg-slate-800 rounded-lg px-4 py-3 max-w-md">
            <p class="text-gray-800 dark:text-gray-100">
              Hi! I‚Äôm your FAQ assistant. Ask me anything by category‚ÄîEmployees, Managers, HRBPs, or Production Site‚Äîor type a question below.
            </p>
          </div>
        </div>
      </div>

      <!-- Input Area -->
      <div class="border-t border-gray-200 dark:border-gray-800 p-4">
        <form id="chatForm" class="flex gap-3" autocomplete="off">
          <label for="messageInput" class="sr-only">Your question</label>
          <input
            type="text"
            id="messageInput"
            placeholder="Ask your question here‚Ä¶"
            class="flex-1 border border-gray-300 dark:border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[rgb(var(--ring))] focus:border-transparent bg-white dark:bg-slate-800 text-gray-900 dark:text-gray-100"
            aria-label="Ask a question"
          />
          <button
            type="submit"
            class="px-5 py-2 rounded-lg font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-[rgb(var(--ring))]"
          >
            Send
          </button>
        </form>
        <div id="recentQ" class="mt-3 flex flex-wrap gap-2"></div>
      </div>
    </section>

    <!-- Suggested Questions -->
    <section class="mt-6">
      <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-3">Frequently Asked Questions</h3>
      <div id="suggested" class="grid md:grid-cols-2 gap-3"></div>
    </section>
  </div>

  <script>
    // ---------- PERSONALIZATION LAYER ----------
    const CONFIG = {
      companyName: "Straumann Group",
      subtitle: "Get instant answers to your workplace questions",
      primaryBg: "bg-blue-600",
      primaryRing: "59 130 246",
      contacts: {
        hr: "we-engage@straumann.com",   // program mailbox surfaced in FAQs
        it: "it-helpdesk@straumann.com",
        hrExt: "‚Äî",
        itExt: "‚Äî",
      },
    };

    // Categories (new taxonomy)
    const CATEGORY_ORDER = ["employees", "managers", "hrbps", "production"];
    const CATEGORY_LABELS = {
      employees: "Employees",
      managers: "Managers",
      hrbps: "HRBPs",
      production: "Production Site",
    };

    // ---------- FAQ DATA (populated from your docs) ----------
    // Notes:
    // - Keep keywords short, lowercase, and include common synonyms for better matching.
    // - Answers are concise summaries tailored for the bot UI.
    // - You can safely edit the text below; structure must remain {category,title,keywords,answer}.
    const FAQ_DATA = [
      /* ===================== EMPLOYEES ===================== */
      {
        category: "employees",
        title: "What is the purpose of the WeEngage survey?",
        keywords: ["purpose", "what is", "weengage", "engagement"],
        answer:
          "WeEngage listens to employees and provides insights on how we lead, collaborate, and nurture culture‚Äîhelping identify strengths and improvements for our shared well-being. (2025 cycle)", // Employees guide
      },
      {
        category: "employees",
        title: "When is the 2025 survey open?",
        keywords: ["deadline", "dates", "when", "open", "close"],
        answer:
          "For 2025, the survey runs from <strong>Nov 3</strong> to <strong>Nov 17</strong>.", // Employees guide
      },
      {
        category: "employees",
        title: "What period should I consider when answering?",
        keywords: ["period", "timeframe", "reference", "window"],
        answer:
          "Please consider your experience from <strong>Nov 2024</strong> up to the present.", // Employees guide
      },
      {
        category: "employees",
        title: "Who is invited to respond?",
        keywords: ["who responds", "eligibility", "invite", "target"],
        answer:
          "All employees (incl. interns) can respond‚Äîeven if on maternity leave, vacation, or long-term sick leave. External/contingent workers or those with employment status changes are not eligible.",
      },
      {
        category: "employees",
        title: "What does ‚Äúengagement‚Äù mean?",
        keywords: ["engagement", "definition", "think feel act"],
        answer:
          "Engagement reflects how people <em>think</em>, <em>feel</em>, and <em>act</em>‚Äîa sense of belonging, purpose, and energy that connects us to work, colleagues, and mission.",
      },
      {
        category: "employees",
        title: "Is the survey confidential?",
        keywords: ["confidential", "anonymous", "privacy"],
        answer:
          "Yes‚Äîresponses are confidential and reported in aggregated form via Viva Glint. Individual responses are not identifiable in reporting; minimum thresholds apply.",
      },
      {
        category: "employees",
        title: "Who can see the results?",
        keywords: ["access results", "who sees", "visibility"],
        answer:
          "Managers see their own team‚Äôs aggregated results (only if ‚â•5 responses). HRBPs and Grow & Culture have broader access; comments are shown only if ‚â•10 responses.",
      },
      {
        category: "employees",
        title: "What happens after results are published?",
        keywords: ["after results", "actions", "follow up"],
        answer:
          "Results are shared with managers and employees. Actions may include 1:1s, feedback, team sessions, training, process improvements, and comms enhancements.",
      },
      {
        category: "employees",
        title: "Who do ‚Äúmy manager‚Äù, ‚Äúmy team‚Äù, and ‚Äúcustomers‚Äù refer to?",
        keywords: ["definitions", "manager", "team", "customers"],
        answer:
          "<strong>My manager:</strong> your direct line manager. <strong>My team:</strong> peers with the same manager. <strong>Customers:</strong> include internal customers you support.",
      },
      {
        category: "employees",
        title: "I recently changed area‚Äîhow should I answer?",
        keywords: ["changed area", "transfer", "new role"],
        answer:
          "Answer based on your current line manager and peers and your experience to date‚Äîeven if the time has been short.",
      },
      {
        category: "employees",
        title: "Will I still be included if I‚Äôm leaving mid-November?",
        keywords: ["leaving", "notice", "resignation"],
        answer:
          "Yes. All employees as of the survey start date (excluding externals) are eligible to participate.",
      },
      {
        category: "employees",
        title: "I don‚Äôt have corporate e-mail‚Äîhow do I access?",
        keywords: ["no email", "access", "qr", "card", "u-number"],
        answer:
          "Use the QR code on posters or a printed card from your manager. Log in with your <strong>U-number</strong> and <strong>date of birth (YYYY-MM-DD)</strong>.",
      },
      {
        category: "employees",
        title: "Can I retake the survey to change answers?",
        keywords: ["redo", "retake", "edit", "change"],
        answer:
          "Yes‚Äîwhile the survey is open you may resubmit. Each time you must answer all questions; only the latest submission counts.",
      },
      {
        category: "employees",
        title: "I‚Äôm on leave‚Äîcan I answer?",
        keywords: ["vacation", "maternity", "sick leave"],
        answer:
          "Yes. If you have email, use your link; otherwise use the QR method with U-number and birth date.",
      },
      {
        category: "employees",
        title: "Can links be accessed from non-STM domains?",
        keywords: ["external email", "domain", "access"],
        answer:
          "No‚Äîaccess is via corporate email. Employees without email should use the QR flow (U-number + birth date).",
      },
      {
        category: "employees",
        title: "I deleted the Viva Glint link‚Äîcan a colleague forward theirs?",
        keywords: ["lost link", "forward", "email"],
        answer:
          "No‚Äîlinks are personal. Viva Glint sends reminders. If still missing, contact your local HRBP for help.",
      },

      /* ===================== MANAGERS ===================== */
      {
        category: "managers",
        title: "What happens after results are shared?",
        keywords: ["after", "actions", "review"],
        answer:
          "Review results with your HRBP and Grow & Culture. Align on context, strengths, gaps, and actions (e.g., workshops, feedback, training).",
      },
      {
        category: "managers",
        title: "I‚Äôm new‚Äîwho evaluates me?",
        keywords: ["new manager", "evaluate", "who"],
        answer:
          "Your current team evaluates you, even if you‚Äôve joined recently.",
      },
      {
        category: "managers",
        title: "Who has access to results?",
        keywords: ["visibility", "access"],
        answer:
          "Managers see their team results. HRBPs and Grow & Culture have broader visibility.",
      },
      {
        category: "managers",
        title: "How do I support employees without corporate email?",
        keywords: ["no email", "support", "access"],
        answer:
          "Provide printed cards and explain the QR access process. If issues persist, contact <a class='underline' href='mailto:we-engage@straumann.com'>we-engage@straumann.com</a>.",
      },
      {
        category: "managers",
        title: "How can I encourage participation?",
        keywords: ["participation", "remind", "engage"],
        answer:
          "Discuss the survey in team meetings (10‚Äì15 mins), reassure confidentiality, provide time to respond, and highlight actions taken since last year.",
      },
      {
        category: "managers",
        title: "Team has uncertainty after recent news‚Äîwhat should I do?",
        keywords: ["uncertainty", "news", "concern", "psychological safety"],
        answer:
          "Host a timely, open session to explain context and take questions. Be clear and honest; invite HRBP/GM if useful. Foster psychological safety and address concerns directly.",
      },
      {
        category: "managers",
        title: "I don‚Äôt know how to read my report‚Äîhelp?",
        keywords: ["analyze report", "how to", "support"],
        answer:
          "Your HRBP and Global weEngage team can support. Check weLearn trainings on the Survey & Reports.",
      },
      {
        category: "managers",
        title: "What actions can managers take based on results?",
        keywords: ["actions", "follow up", "plan"],
        answer:
          "Examples: team offsites, 1:1s, feedback talks, trainings, and engagement activities. Co-create actions with the team.",
      },
      {
        category: "managers",
        title: "Production site time allocation for survey?",
        keywords: ["production", "time", "shift"],
        answer:
          "Encourage participation by scheduling small groups (15‚Äì20 min) during shifts and leveraging QR, kiosks, or shared workstations.",
      },

      /* ===================== HRBPs ===================== */
      {
        category: "hrbps",
        title: "Scope and target audience",
        keywords: ["scope", "target", "who responds"],
        answer:
          "All employees (incl. interns) are invited. Externals/contingent workers and status-change populations are excluded. QR access is available for those without email.",
      },
      {
        category: "hrbps",
        title: "Access to results (HRBPs & Managers)",
        keywords: ["access", "results", "visibility"],
        answer:
          "HRBPs: access can be granted on request (e.g., by Legal Entity). Managers automatically see their team results via the EC roll-up structure.",
      },
      {
        category: "hrbps",
        title: "Distribution & missing invitations",
        keywords: ["distribution", "invite", "missing", "resend"],
        answer:
          "All employees receive personal invitations. If missing, check spam; otherwise the HRBP may request a manual resend by contacting the program owner(s).",
      },
      {
        category: "hrbps",
        title: "Confidentiality thresholds",
        keywords: ["threshold", "min respondents", "comments"],
        answer:
          "Managers see results only if ‚â•5 respondents; comments show only if ‚â•10, ensuring confidentiality.",
      },
      {
        category: "hrbps",
        title: "Critical EC data checks",
        keywords: ["employee central", "data", "reporting lines", "org structure", "job architecture", "tenure", "dob", "username"],
        answer:
          "Validate reporting lines, org structure, job architecture, tenure, date of birth, and username availability in EC‚Äîthey drive visibility, segmentation, and accurate reporting.",
      },
      {
        category: "hrbps",
        title: "Employees with external managers",
        keywords: ["external managers", "roll-up", "hierarchy"],
        answer:
          "If a direct manager is an external (not in Glint), the manager hierarchy breaks. Results still roll up in analysis, but not to that external manager.",
      },
      {
        category: "hrbps",
        title: "Employees without e-mail in EC",
        keywords: ["no email", "qr", "u-number", "dob"],
        answer:
          "They can use QR and log in with U-number and date of birth (YYYY-MM-DD).",
      },
      {
        category: "hrbps",
        title: "Support & access provisioning",
        keywords: ["support", "access", "provisioning", "contacts"],
        answer:
          "HRBPs needing system access should have the Grow Head request it with the program owners, specifying the target population (e.g., Legal Entity). Escalate data/invite issues via standard channels.",
      },

      /* ===================== PRODUCTION SITE ===================== */
      {
        category: "production",
        title: "How can employees without e-mail access the survey?",
        keywords: ["no email", "access", "qr", "card"],
        answer:
          "Use the QR on posters or HR flow; in some regions, managers distribute personal cards with QR and credentials (non-transferable).",
      },
      {
        category: "production",
        title: "Can I answer from a personal device?",
        keywords: ["personal phone", "mobile", "device"],
        answer:
          "Yes‚Äîuse the QR code or access link on any smartphone or smart device.",
      },
      {
        category: "production",
        title: "I lost my access card/QR‚Äîwhat now?",
        keywords: ["lost", "card", "qr", "replacement"],
        answer:
          "Inform your manager, who will coordinate with HR to arrange a replacement or retrieve credentials.",
      },
      {
        category: "production",
        title: "Can we answer during working hours?",
        keywords: ["work time", "shift", "allocation"],
        answer:
          "Yes‚Äîmanagers should allocate time so participation doesn‚Äôt impact shifts.",
      },
      {
        category: "production",
        title: "Is participation mandatory?",
        keywords: ["mandatory", "voluntary", "participation"],
        answer:
          "Participation is voluntary but strongly encouraged to inform improvements.",
      },
      {
        category: "production",
        title: "Are production responses treated differently?",
        keywords: ["production", "weight", "confidential"],
        answer:
          "No‚Äîresponses are confidential and contribute equally to overall results.",
      },
      {
        category: "production",
        title: "Viva Glint confidentiality (production context)",
        keywords: ["privacy", "glint", "confidentiality"],
        answer:
          "Microsoft Viva Glint safeguards confidentiality. Results are only shown in aggregated form with thresholds to prevent identifying individuals.",
      },
      {
        category: "production",
        title: "What does ‚ÄúStraumann Group‚Äù refer to in questions?",
        keywords: ["organization", "what to consider"],
        answer:
          "Consider the global culture (I-We-It; Player & Learner mindset; core beliefs) applied consistently across sites‚Äîlocally grounded, globally connected.",
      },
      {
        category: "production",
        title: "How should I think about Collaboration?",
        keywords: ["collaboration", "teams", "functions"],
        answer:
          "Think about how you and colleagues work together within your team and across functions (Sales, Marketing, R&D, Operations, IT, Finance, HR, etc.).",
      },
    ];

    // Suggested questions aligned to categories
    const SUGGESTED = [
      "When is the 2025 survey open?",
      "Is the survey confidential?",
      "Who can see results?",
      "How do employees without email access the survey?",
      "I‚Äôm a new manager‚Äîwho evaluates me?",
      "What EC data should HRBPs check?",
      "How should production teams allocate time?",
    ];

    // ---------- UI WIRING ----------
    const el = {
      chat: document.getElementById("chatMessages"),
      form: document.getElementById("chatForm"),
      input: document.getElementById("messageInput"),
      suggested: document.getElementById("suggested"),
      categoryButtons: document.getElementById("categoryButtons"),
      recentQ: document.getElementById("recentQ"),
      brandTitle: document.getElementById("brandTitle"),
      brandSubtitle: document.getElementById("brandSubtitle"),
      brandBadge: document.getElementById("brandBadge"),
      botAvatar: document.getElementById("botAvatar"),
      darkToggle: document.getElementById("darkToggle"),
    };

    // Apply branding
    function applyBranding() {
      el.brandTitle.textContent = `${CONFIG.companyName} FAQ Assistant`;
      el.brandSubtitle.textContent = CONFIG.subtitle;
      el.brandBadge.classList.remove("bg-blue-600");
      el.botAvatar.classList.remove("bg-blue-600");
      el.brandBadge.classList.add(CONFIG.primaryBg);
      el.botAvatar.classList.add(CONFIG.primaryBg);
      document.documentElement.style.setProperty("--ring", CONFIG.primaryRing);
    }
    applyBranding();

    // Dark mode toggle (persisted)
    const DARK_KEY = "faq_dark_mode";
    function restoreDark() {
      const pref = localStorage.getItem(DARK_KEY);
      if (pref === "true" || (pref === null && window.matchMedia("(prefers-color-scheme: dark)").matches)) {
        document.documentElement.classList.add("dark");
      }
    }
    restoreDark();
    el.darkToggle.addEventListener("click", () => {
      document.documentElement.classList.toggle("dark");
      localStorage.setItem(DARK_KEY, document.documentElement.classList.contains("dark"));
    });

    // Render suggested questions
    function renderSuggested() {
      el.suggested.innerHTML = "";
      SUGGESTED.forEach(q => {
        const btn = document.createElement("button");
        btn.className = "text-left p-3 bg-white dark:bg-slate-900 rounded-lg hover:bg-blue-50 dark:hover:bg-slate-800 transition-colors border border-gray-200 dark:border-gray-700";
        btn.innerHTML = `<span class="text-blue-600 font-medium">${q}</span>`;
        btn.addEventListener("click", () => askQuestion(q));
        el.suggested.appendChild(btn);
      });
    }
    renderSuggested();

    // Recent questions (persisted)
    const RECENT_KEY = "faq_recent_q";
    function addRecent(q) {
      const list = getRecent();
      if (q.trim().length < 3) return;
      if (list[0] === q) return;
      const next = [q, ...list.filter(x => x !== q)].slice(0, 6);
      localStorage.setItem(RECENT_KEY, JSON.stringify(next));
      renderRecent();
    }
    function getRecent() {
      try { return JSON.parse(localStorage.getItem(RECENT_KEY) || "[]"); } catch { return []; }
    }
    function renderRecent() {
      const rec = getRecent();
      el.recentQ.innerHTML = "";
      rec.forEach(q => {
        const b = document.createElement("button");
        b.type = "button";
        b.className = "text-xs md:text-sm px-3 py-1.5 rounded-full border border-gray-300 dark:border-gray-700 bg-white dark:bg-slate-900 text-gray-700 dark:text-gray-100 hover:bg-gray-50 dark:hover:bg-slate-800";
        b.textContent = q;
        b.addEventListener("click", () => askQuestion(q));
        el.recentQ.appendChild(b);
      });
    }
    renderRecent();

    // ---------- CHAT UX ----------
    function addMessage(content, opts = { role: "bot" }) {
      const wrap = document.createElement("div");
      wrap.className = "chat-message flex items-start space-x-3";
      if (opts.role === "user") {
        wrap.innerHTML = `
          <div class="flex-1"></div>
          <div class="rounded-lg px-4 py-3 max-w-md text-white ${CONFIG.primaryBg}">
            <p>${content}</p>
          </div>
          <div class="w-8 h-8 bg-gray-400 rounded-full flex items-center justify-center flex-shrink-0" aria-hidden="true">
            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
          </div>
        `;
      } else {
        wrap.innerHTML = `
          <div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 text-white ${CONFIG.primaryBg}" aria-hidden="true">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
            </svg>
          </div>
          <div class="bg-gray-100 dark:bg-slate-800 rounded-lg px-4 py-3 max-w-md">
            <p class="text-gray-800 dark:text-gray-100">${content}</p>
          </div>
        `;
      }
      el.chat.appendChild(wrap);
      el.chat.scrollTop = el.chat.scrollHeight;
      return wrap;
    }

    function showTyping() {
      const typing = document.createElement("div");
      typing.id = "typing";
      typing.className = "flex items-start space-x-3";
      typing.innerHTML = `
        <div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 text-white ${CONFIG.primaryBg}" aria-hidden="true">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
          </svg>
        </div>
        <div class="bg-gray-100 dark:bg-slate-800 rounded-lg px-4 py-3">
          <div class="typing-indicator text-gray-500 dark:text-gray-300">Thinking‚Ä¶</div>
        </div>
      `;
      el.chat.appendChild(typing);
      el.chat.scrollTop = el.chat.scrollHeight;
    }
    function removeTyping() {
      const t = document.getElementById("typing");
      if (t) t.remove();
    }

    // ---------- SEARCH / MATCHING ----------
    const norm = s => s.toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu, "");
    const INDEX = FAQ_DATA.map((item, id) => ({
      id,
      category: item.category, // 'employees' | 'managers' | 'hrbps' | 'production'
      title: item.title,
      answer: item.answer,
      keywords: item.keywords.map(norm),
    }));

    function tokenize(q) {
      return norm(q).split(/[^a-z0-9+]+/).filter(Boolean);
    }

    function scoreEntry(tokens, entry, categoryFilter = null) {
      const answerText = norm(entry.title + " " + entry.answer);
      let score = 0;
      for (const kw of entry.keywords) if (tokens.includes(kw)) score += 3;
      for (const t of tokens) if (t.length >= 4 && answerText.includes(t)) score += 1;
      if (categoryFilter && entry.category === categoryFilter) score += 2;
      return score;
    }

    function findBestAnswers(question, categoryFilter = null) {
      const tokens = tokenize(question);
      const scored = INDEX
        .map(e => ({ ...e, _score: scoreEntry(tokens, e, categoryFilter) }))
        .filter(e => e._score > 0)
        .sort((a, b) => b._score - a._score);
      return scored.slice(0, 3);
    }

    function highlight(text, question) {
      const terms = [...new Set(tokenize(question).filter(t => t.length >= 4))];
      let out = text;
      for (const t of terms) {
        const re = new RegExp(`(${t.replace(/[.*+?^${}()|[\]\\]/g, "\\$&")})`, "gi");
        out = out.replace(re, "<mark class='bg-yellow-200 dark:bg-yellow-600/40'>$1</mark>");
      }
      return out;
    }

    // ---------- BEHAVIOR ----------
    let lastCategory = null;

    function answerQuestion(question) {
      const hits = findBestAnswers(question, lastCategory);
      if (hits.length === 0) {
        const fallback =
          `I couldn‚Äôt find a specific answer. For program questions, email <a href="mailto:${CONFIG.contacts.hr}" class="underline">${CONFIG.contacts.hr}</a>. ` +
          `For IT access issues, email <a href="mailto:${CONFIG.contacts.it}" class="underline">${CONFIG.contacts.it}</a>.`;
        return fallback;
      }
      const best = hits[0];
      let html = `<div class="space-y-3">
        <div>
          <div class="text-sm uppercase tracking-wide text-gray-500 dark:text-gray-400">${CATEGORY_LABELS[best.category] || best.category}</div>
          <div class="font-semibold text-gray-900 dark:text-gray-100">${best.title}</div>
          <div class="prose prose-sm dark:prose-invert max-w-none mt-1">${highlight(best.answer, question)}</div>
        </div>`;
      if (hits.length > 1) {
        html += `<div class="pt-2 border-t border-gray-200 dark:border-gray-800">
          <div class="text-sm text-gray-600 dark:text-gray-300 mb-1">Related:</div>
          <ul class="list-disc list-inside space-y-1 text-sm">` +
          hits.slice(1).map(h => `<li><button class="underline text-blue-600 hover:text-blue-700" onclick="askQuestion('${h.title.replace(/'/g, "\\'")}')">${h.title}</button></li>`).join("") +
          `</ul>
        </div>`;
      }
      html += `</div>`;
      return html;
    }

    // ---------- EVENT HANDLERS ----------
    const elForm = document.getElementById("chatForm");
    elForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const q = el.input.value.trim();
      if (!q) return;
      addMessage(escapeHTML(q), { role: "user" });
      el.input.value = "";
      el.input.focus();
      addRecent(q);
      showTyping();
      setTimeout(() => {
        removeTyping();
        const html = answerQuestion(q);
        addMessage(html, { role: "bot" });
      }, 450);
    });

    function askQuestion(q) {
      el.input.value = q;
      el.form.dispatchEvent(new Event("submit"));
    }
    window.askQuestion = askQuestion;

    function selectCategory(cat) {
      lastCategory = cat; // 'employees' | 'managers' | 'hrbps' | 'production'
      const categoryMessages = {
        employees: "Employees: ask about eligibility, confidentiality, access, timeframe, and more.",
        managers: "Managers: ask about reading reports, encouraging participation, and post-results actions.",
        hrbps: "HRBPs: ask about access provisioning, EC data checks, thresholds, and distribution.",
        production: "Production Site: ask about QR access, time allocation, confidentiality, and devices.",
      };
      addMessage(escapeHTML(categoryMessages[cat] || `You selected ${CATEGORY_LABELS[cat] || cat}. What would you like to know?`));
      el.input.focus();
    }
    window.selectCategory = selectCategory;

    // ---------- SUGGESTED ----------
    function renderSuggested() {
      const container = document.getElementById("suggested");
      container.innerHTML = "";
      SUGGESTED.forEach(q => {
        const btn = document.createElement("button");
        btn.className = "text-left p-3 bg-white dark:bg-slate-900 rounded-lg hover:bg-blue-50 dark:hover:bg-slate-800 transition-colors border border-gray-200 dark:border-gray-700";
        btn.innerHTML = `<span class="text-blue-600 font-medium">${q}</span>`;
        btn.addEventListener("click", () => askQuestion(q));
        container.appendChild(btn);
      });
    }
    renderSuggested();

    // ---------- RECENTS ----------
    const RECENT_KEY = "faq_recent_q";
    function addRecent(q) {
      const list = getRecent();
      if (q.trim().length < 3) return;
      if (list[0] === q) return;
      const next = [q, ...list.filter(x => x !== q)].slice(0, 6);
      localStorage.setItem(RECENT_KEY, JSON.stringify(next));
      renderRecent();
    }
    function getRecent() {
      try { return JSON.parse(localStorage.getItem(RECENT_KEY) || "[]"); } catch { return []; }
    }
    function renderRecent() {
      const rec = getRecent();
      el.recentQ.innerHTML = "";
      rec.forEach(q => {
        const b = document.createElement("button");
        b.type = "button";
        b.className = "text-xs md:text-sm px-3 py-1.5 rounded-full border border-gray-300 dark:border-gray-700 bg-white dark:bg-slate-900 text-gray-700 dark:text-gray-100 hover:bg-gray-50 dark:hover:bg-slate-800";
        b.textContent = q;
        b.addEventListener("click", () => askQuestion(q));
        el.recentQ.appendChild(b);
      });
    }
    renderRecent();

    // ---------- UTILS ----------
    function escapeHTML(s) {
      return s.replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c]));
    }
  </script>
</body>
</html>
